---
title: "PrepareCorpus"
author: "Olga Alieva"
date: "2022-12-10"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Description 

This file contains code for extracting a corpus of Ancient Greek texts from Perseus.

## Load libraries
```{r}
library(dplyr)
library(rperseus)
library(stringr)
library(tidytext)
library(ggplot2)
```

## RPerseus: Select Authors and Works
```{r}
# group names
group_names <- c("Lucianus", "Gorgias", "Antisthenes", "Lysias", "Plato", "Aristotle", "Isocrates", "Alcidamas", "Polybius", "Herodotus", "Plotinus", "Xenophon", "Plutarch")

# subset authors
subset_authors <- perseus_catalog %>% 
  filter(group_name %in% group_names,
         language == "grc")

# select < 5 texts for each author
names <- subset_authors %>% 
  group_by(group_name) %>% 
  count() %>% 
  filter(n > 4) %>% 
  pull(group_name) 
set.seed(1234)
subset <- subset_authors %>% 
  filter(group_name %in% names) %>% 
  group_by(group_name) %>% 
  slice_sample(n=4)
subset_join <- subset_authors %>% 
  filter(!group_name %in% names) %>% 
  bind_rows(subset) %>% 
  select(-description, -language)

subset_join %>% 
  group_by(group_name) %>% 
  count() # 10 groups
subset_join %>% 
  count(n()) # 30 works
```

## Retrieve texts and save
```{r}
# pull urns
urns <- subset_join %>% 
  pull(urn)

# get texts
corpus <- tibble()
for (i in 1:length(urns)) {
  message(paste("getting text", i, "out of", length(urns)))
  text <- get_perseus_text(urn = urns[i])
  corpus <- text %>% bind_rows(corpus)
}

# tidy up
corpus <- corpus %>% 
  select(-urn, -language, -description, -section) %>% 
  rename(author = group_name, work = label) %>% 
  relocate(text, .after = last_col())
```

# Tokenize texts and preprocess
```{r}
# remove several capital Greek letters in a row 
corpus$text <- corpus$text %>% 
  str_remove_all("[:upper:]{2,}")

# remove Latin characters (mostly editorial notes)
corpus$text <- corpus$text %>% 
  str_remove_all("[A-Za-z]")

# remove punctuation
corpus$text <- corpus$text %>% 
  str_remove_all("[:punct:]")

# tokenize (this will be a very long data!)
corpus <- corpus %>% 
  unnest_tokens(word, text)

nrow(corpus)
```

# Inspect corpus
```{r}
# compare text lengths
corpus %>% group_by(author) %>% 
  count() %>%
  ggplot(aes(x = reorder(author, n), y = n, fill=author)) +
  geom_col(show.legend = F) + 
  coord_flip() + 
  theme_bw() + 
  xlab(NULL)
```

# Sample long texts
```{r}
# select long texts 
long.w <- corpus %>% 
  group_by(author, work) %>% 
  count() %>% 
  filter(n > 15000) %>% 
  pull(work)
long.w

# make samples for long texts
long.div <- corpus %>% 
  filter(work %in% long.w) %>% 
  group_by(work) %>% 
  mutate(sample = round((row_number() + 15000) / 15000)) 

my_samples <- c(1:3)

# select samples from long texts
long.sel <- long.div %>% 
  group_by(author, work) %>% 
  filter(sample %in% my_samples)
```

# Join long and small texts
```{r}
small.t <- corpus %>% 
  filter(!work %in% long.w)
corpus <- bind_rows(small.t, long.sel) # NAs will be produced
```

# Plot corpus size
```{r}
# plot
corpus %>% 
  group_by(author) %>% 
  count() %>%
  ggplot(aes(x = reorder(author, n), y = n, fill=author)) +
  geom_col(show.legend = F) + 
  coord_flip() + 
  theme_bw() + 
  xlab(NULL)
```

# Corpus Stats
```{r}
corpus %>% group_by(author) %>% count()
```

# Plot Sample Size
```{r}
# plot sample size
corpus %>% group_by(work, sample) %>% count() %>%
  ggplot(aes(x=n)) + geom_freqpoly()
```

# Add Group IDs
```{r}
# add group ids
groups <- corpus %>% group_by(author, work, sample) %>% 
  mutate(group_id = cur_group_id())
ids <- sort(unique(groups$group_id))
ids
```

# Write text Files
```{r}
# write text files 
for(i in ids){
  message(paste("processing sample ", i))
  author <- groups %>% filter(group_id == i) %>% 
    pull(author) %>% unique()
  title <- groups %>% filter(group_id == i) %>% 
    pull(work) %>% unique()
  id <- i
  text <- groups %>% filter(group_id == i) %>% pull(word)
  filename <- paste0(author, "_", title, "_", id, ".txt")
  write.table(text, file = filename, row.names = FALSE, 
              col.names = FALSE, quote = FALSE)
}
```
